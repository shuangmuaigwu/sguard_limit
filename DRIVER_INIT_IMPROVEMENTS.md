# 驱动初始化失败改进说明

## 问题描述
原程序在驱动初始化失败时，错误提示过于简单，用户难以根据错误信息定位和解决问题。

## 改进内容

本次改进对 `kdriver.cpp` 文件中的所有驱动初始化相关错误消息进行了全面优化，包括：

### 1. 资源提取错误（_extractResource函数）
- **FindResource失败**: 增加了应用程序文件完整性检查、杀毒软件干扰、文件损坏等原因说明
- **SizeofResource失败**: 增加了资源大小检查和文件编译问题说明
- **LoadResource失败**: 增加了系统内存不足等原因说明
- **LockResource失败**: 增加了内存资源锁定失败的原因说明
- **fopen失败**: 增加了管理员权限、目录权限、杀毒软件实时保护等详细说明

### 2. 服务管理错误（_startService函数）
- **OpenSCManager失败**: 增加了管理员权限检查、服务控制管理器状态检查等说明
- **CreateService失败**: 增加了服务残留、路径错误、杀毒软件干扰等详细说明和解决方法
- **QueryServiceStatus失败**: 增加了服务状态异常的原因说明
- **ControlService失败**: 增加了服务占用、权限不足、杀毒软件阻止等原因和解决方法
- **服务停止超时**: 增加了超时原因和手动删除服务的命令说明
- **StartService失败**: 增加了驱动文件损坏、Secure Boot、驱动签名强制、测试模式等详细说明

### 3. 驱动设备错误（load函数）
- **CreateFile失败**: 增加了设备句柄打开失败的原因，包括设备未创建、程序实例冲突、驱动加载失败等

### 4. 证书安装错误
- **注册表导入失败**: 改进了证书安装失败提示，说明可以尝试继续但后续可能需要手动安装证书

## 改进特点

每个错误消息现在都包含：

1. **清晰的错误描述**: 用中文说明具体哪个操作失败了
2. **可能的原因**: 列举导致该错误的常见原因（3-4个）
3. **解决方法**: 提供具体的解决步骤和命令
4. **错误代码**: 显示Windows系统错误代码，方便高级用户诊断
5. **联系方式**: 在适当的地方提供QQ群号，方便用户反馈问题

## 示例对比

### 改进前：
```cpp
return unexpected_error(__FUNCTION__ "(): CreateService失败。", GetLastError());
```

### 改进后：
```cpp
DWORD error = GetLastError();
return unexpected_error(format(
    __FUNCTION__ "(): 无法创建内核驱动服务。\n\n"
    "可能的原因:\n"
    "1. 没有管理员权限，请右键程序选择\"以管理员身份运行\"。\n"
    "2. 系统中服务已经存在或同名服务残留，但无法删除。\n"
    "3. 驱动程序文件路径不正确: {}\n"
    "4. 系统服务数据库不稳定，建议重启计算机后重新尝试。\n\n"
    "解决方法:\n"
    "- 打开命令提示符(windows键+R，输入cmd)，右键\"以管理员身份运行\"，输入sc query，检查是否有名为'{}'的服务，如果有，右键删除该服务后重试。\n"
    "- 尝试关闭非必要杀毒软件，例如：第三方杀毒软件或火绒等，然后重新尝试。\n\n"
    "错误代码: 0x{:08X}", sysfile_LoadPath, DRIVER_NAME, error), error);
```

## 文件统计

- 修改文件: `sguard_limit/kdriver.cpp`
- 行数变化: 564行 → 655行 (+91行)
- 改进的错误消息数量: 13个

## 预期效果

通过这些改进，用户在遇到驱动初始化失败时，能够：

1. 快速了解失败的具体原因
2. 根据提示自行解决大部分常见问题
3. 减少在QQ群中重复询问同一问题的次数
4. 提供更准确的错误代码给开发者，便于远程诊断

## 注意事项

- 所有错误消息使用GBK编码以保持与原文件一致
- 保持了原有的错误处理逻辑，只增强了错误消息内容
- 没有修改任何业务逻辑，只是改进了用户体验
